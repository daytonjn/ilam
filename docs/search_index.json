[["index.html", "iLAM: imaging Locomotor Activity Monitor 1 Description", " iLAM: imaging Locomotor Activity Monitor Jacob Dayton &amp; Avalon Owens 2023-08-20 1 Description Historically, most insect chronoecological research uses direct observations, cameras, and/or infrared beam-based monitors to quantify movement across timed intervals. Although many systems are cheaper than the traditional infrared locomotor activity monitors (e.g., DAM/LAM), these options remain complicated to build and/or computationally intensive. We developed the imaging Locomotor Activity Monitor (iLAM), an affordable system for activity tracking. The iLAM utilizes a Raspberry Pi Zero W computer and night-vision camera inside a flight cage to regularly photograph a population of insects at user-defined intervals. Customizable, modular R-scripts process the consecutive images with imager and output a file containing the number, size, location, and timing of all identified movements. Output can be converted into DAM format or directly analyzed within the Rethomics framework. Figure 1.1: iLAM Workflow Figure 1.2: Representative firefly movements identified by iLAM system This documentation provides instructions for (1) iLAM construction, (2) Raspberry Pi setup, (3) Image analysis in R, (4) Conversion of iLAM output to DAM format in R, and (5) Example results from Rethomics. "],["flight-cage-construction.html", "2 Flight-Cage Construction", " 2 Flight-Cage Construction The paired iLAM flight-cages described in our original publication used the following materials. Table 2.1: iLAM materials Item Function Units/Setup Black mosquito head net mesh big size, 6.69” x 3.94” x 1.38” Cage 2 Wooden embroidery hoop, 14” Cage 4 Wooden embroidery hoop, 8” Cage 2 Hardwood plywood, 1/2” x 4’ x 8’ Structure 0.25 Steel threaded rod, 3/8”-16 x 2’ Structure 6 Steel hex nut, 3/8”-16 Structure 36 Steel washer, 3/8” Structure 36 No See Um fiberglass mesh screening, 36” x 25’ Cover 0.04 Falcon tube, 50mL Water 2 Braided cotton roll, 4” Water 2 Sponge Water 2 Raspberry Pi Zero W Computer 2 Raspberry Pi Zero W camera module night vision w/ 3.6mm, 2pcs IR sensor LED light Camera 2 SanDisk Ultra 32GB microSD card Memory 2 Micro USB charging cord/block Power 2 All materials were purchased from local hardware stores, art supply chains, Raspberry Pi suppliers, and Amazon The three cage levels were made with the following cuts: Top: 31 1/2” x 10 1/2” Two Circles: 13 3/8” diameter (&lt;14” hoop) Bottom: 31 1/2” x 10 1/2” Two Circles: 7 1/2” diameter (&lt;8” hoop) Hole for camera ribbon Base: 31 1/2” x 10 1/2” Figure 2.1: iLAM flight-cage: front view Figure 2.2: iLAM flight-cage: top-down view Tips: Lifespan of experimental insects increased when moist sponges and falcon tube with cotton roll and water were provided at the base of the iLAM Duct-tape around the camera ribbon cable hole and camera limited escape by experimental insects, particularly the small fireflies (!) "],["raspberry-pi-zero-wcamera-setup.html", "3 Raspberry Pi Zero W/Camera Setup", " 3 Raspberry Pi Zero W/Camera Setup 1. install operating system: use microSD adapter to mount SD card on laptop download and open Raspberry Pi Imager select OS → other → Raspbian Pi OS Lite replace formatted microSD card in raspberry pi connect raspberry pi to power, keyboard, monitor connect raspberry pi to power, keyboard, monitor use microHDMI to HDMI adapter for monitor use microUSB to USD adapter for keyboard 2. login with default information: raspberrypi login: pi password: raspberry 3. bring up the configuration menu: sudo raspi-config use arrow keys + enter to navigate 1 → S1 connect to wifi SSID: wifi network name passphrase: wifi password 1 → S3 change pi password 1 → S4 change pi name (not login) 3 → I1 enable camera attachment 3 → I2 enable remote access (ssh) 5 → L2 set timezone 5 → L3 set keyboard layout this step is only required if # key maps incorrectly Finish (type y when asked if you want to reboot) 4. add static IP address for remote access: https://raspberrypi-guide.github.io/networking/set-up-static-ip-address 5. log in remotely through terminal: ssh login_name@[IP] password: 6. make a folder named still to hold images: mkdir still_[xxx] Note: [xxx] refers to the login name of the Raspberry Pi associated with the iLAM 7. make a folder named script to hold scripts: mkdir script_[xxx] 8. make a script using a text-editor (e.g., nano) named still_[xxx].sh: sudo nano ./script_[xxx]/still_[xxx].sh copy-paste or type out the following text: #!/bin/bash DATE=$(date +&quot;%m%d.%H%M&quot;) sudo raspistill -o /home/$USER/still_$USER/$USER.$DATE.jpg this script will take images and save them along w/ metadata: the first line is a necessary part of any bash file with instructions the second line is how you format the date and time in the file name the third line actually tells the pi to take a photo and store it as such hit control^X to exit (type y when asked if you want to save) 9. if mounting raspberry pi zero W to a remote directory, then repeat the same steps for mount_[xxx].sh: #!/bin/bash DATE=$(date +&quot;%m%d.%H%M&quot;) sleep 10s cp /home/$USER/still_$USER/$USER.$DATE.jpg /home/$USER/mount_$USER/ 10. set the script to run periodically with crontab: access the crontab file sudo crontab -e select first option to edit the crontab in nano copy the following to the bottom of the file: */2 * * * * sh /home/$USER/script_$USER/still_$USER.sh 2&gt;&amp;1 this tells the pi to execute the still.sh file every 2 minutes (the order is minute, hour, day of month, month, day of week) make sure that each input is separated by at least one space when setting up a new crontab, always run it past crontab.guru! hit control^X to exit (type y when asked if you want to save) if you are mounting to a remote directory, you will also want to add this line #if mounting files to a remote directory, add this line which copies (uploads) the still file from your pi to a remote database */2 * * * * sh /home/$USER/script_$USER/mount_$USER.sh 11. copy image files from pi to laptop: log in to the linux/powershell on your laptop run the following command from the computer that you want to download images onto scp pi@[IP]:~/still_[xxx]/*.jpg ~/Desktop other useful commands: * wildcard (e.g. *.jpg == all jpeg files) tab autocomplete, if code is unambiguous control^A bring cursor to beginning of line control^E bring cursor to end of line control^C kill process clear clear all previous text from terminal ls list all contents in current folder cd directory_path change to named folder cd ~ go to home directory cd .. go up one folder level cd - go back to last folder mkdir dir_name create EMPTY folder (directory) rmdir dir_name remove EMPTY folder rm file_name remove a file rm -f file_name remove a file without asking for permission rm -r dir_name recursively remove all files from folder rm -rf dir_name forcefully remove all files from folder ren name_1 name_2 rename something to something else cp file_1 file_2 copy file_1 to file_2, creates duplicate. note: if file_2 exists will overwrite (NO warning) cp -r dir_1 dir_2 copy folder and its contents nano file_name make named file and open text editor sudo reboot reboot pi sudo shutdown now safely shutdown pi (reboots when plugged in again) If raspistill will not take a picture and returns *failed to open vchiq instance: Verify that the camera is connected and the ribbon cable is not damaged: vcgencmd get_camera Determine if the camera or the still_[xxx].sh script is the issue: raspistill -o /home/$USER/test.jpg Modify permissions of the camera: sudo chmod777 /dev/vchiq A Linux reader is required to read the Raspian imaged SD card, when plugged into a Windows PC. Linux Reader is a free option. Instructions can be found here. "],["post-process-image-segmentation.html", "4 Post-Process Image Segmentation", " 4 Post-Process Image Segmentation Below is a walk-through for the post-process image segmentation (i.e., blob identification) of iLAM images 1. Organize your file directory structure in a logical structure Universal iLAM functions are within ~/iLAM/scripts/ ~/iLAM/exp_a/ contains images, metadata, and analysis scripts specific to Experiment A Experiment A’s images from ilam_01 and ilam_02 are saved in ~/iLAM/exp_a/ilam_01/ and ~/iLAM/exp_a/ilam_02/, respectively CSV output containing the size, location, and timing of all blobs/movements for each iLAM cages for Experiment A (i.e., ilam_01 and ilam_02):~/iLAM/exp_a/iLAM_exp_a.txt/, with corresponding metadata: ~/iLAM/exp_a/metadata_exp_a.csv/ ## levelName ## 1 iLAM ## 2 ¦--exp_a ## 3 ¦ ¦--ilam_01 ## 4 ¦ ¦ ¦--ilam01.0707.2058.jpg ## 5 ¦ ¦ °--ilam01.0707.2100.jpg ## 6 ¦ ¦--ilam_02 ## 7 ¦ ¦ ¦--ilam02.0707.2058.jpg ## 8 ¦ ¦ °--ilam02.0707.2100.jpg ## 9 ¦ ¦--scripts ## 10 ¦ ¦ ¦--analyze_experiment.R ## 11 ¦ ¦ ¦--exp_a_ilam01.R ## 12 ¦ ¦ ¦--exp_a_ilam02.R ## 13 ¦ ¦ ¦--run_exp_a_ilam01.sh ## 14 ¦ ¦ °--run_exp_a_ilam02.sh ## 15 ¦ ¦--metadata_exp_a.csv ## 16 ¦ °--iLAM_exp_a.txt ## 17 ¦--exp_b ## 18 ¦ ¦--ilam_01 ## 19 ¦ ¦--ilam_02 ## 20 ¦ °--scripts ## 21 °--scripts ## 22 ¦--find_movements.R ## 23 ¦--find_threshold.R ## 24 ¦--make_dam_file.R ## 25 ¦--make_gif.R ## 26 ¦--parse_movements.R ## 27 °--plot_movements.R 2. Perform image segmentation for images taken from each iLAM (exp_a_ilam01.R, exp_a_ilam02.R, etc.) Load required packages and iLAM functions library(imager) library(tidyverse) library(reshape2) library(dplyr) library(plyr) library(lubridate) library(readr) library(stringr) library(plotrix) setwd(&quot;/~/iLAM/exp_a/&quot;) #read in iLAM functions for (f in list.files(&quot;../scripts&quot;, pattern=&quot;*.R&quot;, full.names = TRUE)) { source(f) Change values for every cage and experiment: crop (x_left, x_right, etc.), settings for image segmentation (blur, threshold, clean), species characters (genus, species, color) pi_sub_folder &lt;- &quot;ilam01&quot; sex &lt;- &quot;male&quot; #cage/project-specific #Crop-settings x_left &lt;- 425 #cage-specific, depending on camera arrangement x_right &lt;- 2225 #cage-specific, depending on camera arrangement y_bot &lt;- 100 #cage-specific, depending on camera arrangement y_top &lt;- 1700 #cage-specific, depending on camera arrangement #change following values for every experiment out_file_name = &quot;iLAM_exp_a&quot; #project-specific n_thr = 0.999 #species-specific, depending on IR reflectance/contrast with background n_cln = 10 #species-specific, depending on IR reflectance n_max = 75000 #species-specific, pixel differences above this value will be considered as noise start_photophase = 5 #project-specific, time that lights turn on end_photophase = 21 #project-specific, time that dark starts genus = &quot;photinus&quot; #project-specific species = &quot;marginellus&quot; #project-specific animal = &quot;black&quot; #project-specific, during the night, does the animal appear &quot;white&quot; on a dark background or &quot;black&quot; on a light background? This is VERY important (!) because it determines whether &quot;movements&quot; identify insects whom left vs. arrived between frames ### Create a vector of .jpg image file names to be analyzed file_names &lt;- list.files(pi_sub_folder, pattern= &quot;*.jpg&quot;, full.names = TRUE) Note: If you do not know which values to use for cropping (x_left, x_right, y_bot, y_top), you can test with this command. Historically, we identify crop setting that a) remove the outer edge of the cage and to center the ceiling and b) keep the picture area constant across all iLAMs (e.g., 1800x1600 pixels) load.image(file_names[1]) %&gt;% imsub(x %inr% c(x_left,x_right), y %inr% c(y_bot,y_top)) %&gt;% plot() Find all movements by image subtraction, global thresholding, and blob detection in the iLAM wrapper function find_movements() out &lt;- find_movements(files = file_names, # list of file names n_thr = n_thr, # threshold value (0.992 == &quot;0.8%&quot;) n_cln = n_cln, # value for cleaning (number of pixels) n_grw = 1.5, # multiplier for n_cln (shrink vs. grow) n_blr = 3, # let user select blur radius n_max = 75000, # upper cut-off for # pixel differences x_left = x_left, # value for crop on x min x_right = x_right, # value for crop on x max y_bot = y_bot, # value for crop on y min y_top = y_top, # value for crop on y max find_thr = T, # T or F type_thr = &quot;absolute&quot;, p_sample = 0.05, # If 5% of the total images &lt; 100, then increase this value channel = &quot;grayscale&quot;, animal = animal) Update and save output containing all identified blobs, their size and location as a .csv in the current working directory. Important: Even under optimal setting, sometimes there are “noisy” timepoints when blobs cannot easily be identified after subtracting two consecutive images. In these instances, 2,000,000 is assigned to the .csv for subsequent filtering and removal #adds additional columns to dataframe out$ID &lt;- paste0(n_thr*100,&quot;%_&quot;, &quot;s&quot;, n_cln, &quot;g&quot;, 1.5*n_cln) out$sex &lt;- sex out$genus &lt;- genus out$species &lt;- species if (file.exists(paste0(out_file_name,&quot;.csv&quot;))){ write.table(out, file = paste0(out_file_name,&quot;.csv&quot;), append = TRUE, quote = TRUE, sep = &quot;,&quot;, row.names = FALSE, col.names = FALSE) } else{ write.csv(out, file = paste0(out_file_name,&quot;.csv&quot;), col.names = TRUE, row.names = FALSE) } rm(out) Use plot_movements() to visualize movements by plotting detected blobs onto a subset of images #circles in bottom left corner denote standards of sizes: 12.8k px, 3.2k px, 800 px, 200 px, 50 px plot_movements(pi_sub_folder, by_change, x_left, x_right, y_bot, y_top) Figure 4.1: iLAM plot_movements() image If desired, make a gif from plotted images with make_gif() make_gif(out_file_name, pi_sub_folder) Figure 4.2: iLAM make_gif() output Note: For more details/customization, look “under-the-hood” at the find_movements() and find_threshold() functions iLAM scripts can be cloned and downloaded from [insert link] "],["make-dam-output.html", "5 Make DAM Output", " 5 Make DAM Output Read in iLAM output from image_analysis and parse into a dataframe containing the size, centroid location, and origin (time, pi) of all identified blobs (by_change) out_file_name = &quot;Pgreeni&quot; start_photophase = 5 #project-specific, time that lights turn on end_photophase = 21 #project-specific, time that dark starts #parse movements into workable dfs: all movements (by_change) and by_change_Pg &lt;- parse_movements(file_mvmnts = paste0(out_file_name,&quot;.csv&quot;), start_photophase = start_photophase, end_photophase = end_photophase) Table 5.1: iLAM by_change data frame s x y d ID sex genus species 2000000 0 0 mothra03.0624.2100 99.9%_s10g15 male photinus greeni 2799 1256 35 mothra03.0624.2102 99.9%_s10g15 male photinus greeni 2189 150 466 mothra03.0624.2102 99.9%_s10g15 male photinus greeni 731 1282 40 mothra03.0624.2104 99.9%_s10g15 male photinus greeni 442 1311 51 mothra03.0624.2104 99.9%_s10g15 male photinus greeni Collapse all identified blobs (within by_change_[]) into a summarized dataframe containing the sum of blobs and number of blobs/movements observed per analyzed frame/timepoints (by_frame_[]) by_frame_Pg &lt;- by_change_Pg %&gt;% ungroup() %&gt;% group_by(pi, ID, time, treatment) %&gt;% summarize(n = length(s[!is.na(s)]), #number of blobs of size (s) != NA s = sum(s, na.rm = TRUE)) %&gt;% #sum of blob sizes, NA removed mutate(n = ifelse(s == 0, 0, n)) %&gt;% #if sum of blobs=0, then n&lt;-0 (otherwise it&#39;d be 1) distinct(pi, ID, time, treatment, n, s) #sanity check to remove any duplicates Noisy values were initially assigned an absurd value (2,000,000). This step changes 2,000,000 with NA and then replaces with average value of the preceding and succeeding timepoints by_frame_Pg &lt;- by_frame_Pg %&gt;% ungroup() %&gt;% mutate(s = replace(s, s==2000000, NA), n = replace(n, is.na(s), NA)) by_frame_Pg &lt;- by_frame_Pg %&gt;% group_by(pi) %&gt;% mutate(s = round((na.locf0(s, fromLast = TRUE) + na.locf0(s, fromLast = FALSE))/2,0), n = round((na.locf0(n, fromLast = TRUE) + na.locf0(n, fromLast = FALSE))/2,0)) %&gt;% ungroup() by_frame_Pg &lt;- by_frame_Pg %&gt;% ungroup() %&gt;% mutate(s = replace(s, is.na(s), 0), n = replace(n, is.na(n), 0)) dplyr::filter(by_frame_Pg, n&gt;0) %&gt;% group_by(pi) %&gt;% summarise(blob_size = mean((s/n), na.rm=TRUE)) #output the average blob size Table 5.2: iLAM by_frame data frame …1 pi ID time treatment n s 1 mothra01 99.9%_s10g15 2022-06-24 21:00:00 D 0 0 2 mothra01 99.9%_s10g15 2022-06-24 21:02:00 D 4 4084 3 mothra01 99.9%_s10g15 2022-06-24 21:04:00 D 2 2684 4 mothra01 99.9%_s10g15 2022-06-24 21:06:00 D 5 8803 5 mothra01 99.9%_s10g15 2022-06-24 21:08:00 D 9 18515 Use iLAM wrapper function make_dam_file to convert by_frame_[] into a DAM-like output and save as a DAM file with summed blob sizes/timepoint ilam_Pg = make_dam_file(by_frame_Pg, variable_name = &quot;s&quot;) #output a tab-delimited file containing write_tsv(ilam_Pg, &quot;ilam_Pg.tsv&quot;, col_names = F) write_tsv(ilam_Pg, &quot;Monitor42.txt&quot;, col_names = F) #some analysis programs require Monitor##.txt name Table 5.3: iLAM by_frame converted to DAM format X1 X2 X3 X4 X5 X6 X7 X8 X9 X10 X11 X12 X13 X14 X15 X16 X17 X18 X19 X20 X21 X22 X23 X24 X25 X26 X27 X28 X29 X30 X31 X32 X33 X34 X35 X36 X37 X38 X39 X40 X41 X42 1 24 Jun 22 21:00:00 1 0 42 0 Ct 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 2 24 Jun 22 21:02:00 1 0 42 0 Ct 0 0 4084 1668 4988 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 3 24 Jun 22 21:04:00 1 0 42 0 Ct 0 0 2684 2981 3666 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 24 Jun 22 21:06:00 1 0 42 0 Ct 0 0 8803 22280 4058 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 5 24 Jun 22 21:08:00 1 0 42 0 Ct 0 0 18515 17325 5093 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 Use iLAM wrapper function make_dam_file to convert by_frame_[] into a DAM-like output and save as a DAM file with the number of blobs/timepoint #parse movements into workable dfs: all movements (by_change) and by_change_Pg &lt;- parse_movements(file_mvmnts = paste0(out_file_name,&quot;.csv&quot;), start_photophase = start_photophase, end_photophase = end_photophase) by_frame_Pg = filter_nblobs(by_change_Pg) #filter out small nblobs using iLAM wrapper filter_nblobs() ilam_Pg = make_dam_file(by_frame_Pg, variable_name = &quot;n&quot;) write_tsv(ilam_Pg, &quot;ilam_Pg_n.tsv&quot;, col_names = F) write_tsv(ilam_Pg, &quot;Monitor43.txt&quot;, col_names = F) #some analysis programs require Monitor##.txt name Table 5.4: iLAM by_frame converted to DAM format X1 X2 X3 X4 X5 X6 X7 X8 X9 X10 X11 X12 X13 X14 X15 X16 X17 X18 X19 X20 X21 X22 X23 X24 X25 X26 X27 X28 X29 X30 X31 X32 X33 X34 X35 X36 X37 X38 X39 X40 X41 X42 1 24 Jun 22 21:00:00 1 0 42 0 Ct 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 2 24 Jun 22 21:02:00 1 0 42 0 Ct 0 0 2 0 2 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 3 24 Jun 22 21:04:00 1 0 42 0 Ct 0 0 2 1 2 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 24 Jun 22 21:06:00 1 0 42 0 Ct 0 0 5 3 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 5 24 Jun 22 21:08:00 1 0 42 0 Ct 0 0 8 6 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 "],["analyze-output.html", "6 Analyze Output", " 6 Analyze Output "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
